/****************************************************************************
 * DESCRIPTION:
 *             Handles sysconfig File
 *
 * $Id: sysconfig.cpp,v 1.4 2005/10/03 14:05:20 ralf Exp $
 *
 * Contact:    ranga@teddycats.de
 *
 * Copyright (C) 2004 by Ralf Dotzert
 ****************************************************************************/

#include <map>
#include <string>
#include <vector>
#include <stdio.h>
#include <string.h>
#include <errno.h>

#include "config.h"
#include "debug.h"
//#include "plugin.h"
#include "sysconfig_vdr.h"
//#include "util.h"

using std::pair;
using std::map;
using std::string;
using std::vector;

#define MAXLENGTH 256

// ----- class cSysConfig_vdr ------------------------------------------------------


cSysConfig_vdr::~cSysConfig_vdr()
{
    for (mapConstIter_t iter = sysMap_.begin(); iter != sysMap_.end(); ++iter)
    {
        delete[]iter->second;
    }
}


bool
cSysConfig_vdr::Load(const char *fname)
{
    int count = 0;
    const char *line;
    fileName_ = strdup(fname);
    int fp = open(fname, O_RDONLY);
    if (fp)
    {
        while ((line = ReadLine(fp)) != NULL)
        {
            AddLine(line);
            delete[]line;
            count++;
        }
        close(fp);
    }
    else
    {
        //printf(DBG  "   .............. cSysConfig_vdr -- LoadFile  %s Failed !!! \n", fname);
        //DLOG("%s: can`t open: %s, errno=%d\n", ERR, fileName_.c_str(), errno);
        sysMap_.clear();
    }
    return true;
}


/**
 * Save cSysConfig_vdr file
 * @return true on success
 */
bool
cSysConfig_vdr::Save()
{
    FILE *fp = fopen(fileName_.c_str(), "w");
    if (!fp)
    {
        DLOG("%s: Could not write file: %s, errno=%d\n", ERR,
             fileName_.c_str(), errno);
        return false;
    }

    fprintf(fp, "#\n"
            "# Generated by Setup-Plugin, \n"
            "# (c) 2005 by Ralf Dotzert and MiniVDR.de\n"
            "# (c) 2006 and Markus Hahn at Reel-Multimedia.com\n" "#\n\n");

    for (mapConstIter_t iter = sysMap_.begin(); iter != sysMap_.end(); ++iter)
    {
        fprintf(fp, "%s=\"%s\"\n", iter->first.c_str(), iter->second);
    }
    fclose(fp);

    CopyToTftpRoot(fileName_.c_str());

    return true;
}

/**
 * read one line from opened file
 * @param fp opened filepointer
 * @return null if EOF or allocated character String holding one line
 */
const char *cSysConfig_vdr::ReadLine(int fd)
{
    char c;
    char buf[1024];
    int i = 0;
    int maxLen = static_cast < int >(sizeof(buf)) - 1;
    char *line = NULL;
    while (read(fd, &c, 1))
    {
        if (c == '\n' || i == maxLen)
        {
            line = new char[i + 1];
            strncpy(line, buf, i);
            line[i] = '\0';
            //dsyslog (DBG " cSysConfig_vdr readline %s ",line);
            return line;
        }
        else
            buf[i++] = c;
    }
    return line;
}

/**
 * Add the given line from sysconfig file an split it in Name an Variable
 * @param line allocated buffer holding one line
 */

void
cSysConfig_vdr::AddLine(const char *line)
{
    //dsyslog(DBG  "   AddLine   %s", line);
    vector < char >v(strlen(line) + 1);
    char *l = &v[0];
    strcpy(l, line);
    char *key = NULL;
    char *val = new char[MAXLENGTH];    //XXX!

    if (strlen(l) > 0 && l[0] != '#')   // comment line
    {
        char *tmp = NULL;
        char *strtok_next;
        if ((key = strtok_r(l, "=", &strtok_next)) != NULL &&
            (tmp = strtok_r(NULL, "\"", &strtok_next)) != NULL)
        {
            strncpy(val, tmp, MAXLENGTH - 1);   //XXX!
            //dsyslog(DBG " SysConf Insert key \"%s\"-> \"%s\" ",key, val);
            sysMap_.insert(map < string, char *>::value_type(key, val));
        }
    }
}
